apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-topic-init
  namespace: redpanda
  annotations:
    # Run after redpanda is ready
    argocd.argoproj.io/hook: PostSync
spec:
  template:
    spec:
      containers:
      - name: rpk-topic-create
        image: docker.redpanda.com/redpandadata/redpanda:v23.3.4
        command: ["/bin/bash", "-c"]
        args:
        - |
          echo "Waiting for Redpanda to be ready..."
          rpk cluster health --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          echo "Creating topics..."
          # E1.S2: audit.events.v1 (12 partitions, replication 3)
          rpk topic create audit.events.v1 -p 12 -r 3 --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          # E1.S2: audit.events.dlq (3 partitions, replication 3)
          rpk topic create audit.events.dlq -p 3 -r 3 --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          echo "Topics created successfully."
        env:
        - name: ADMIN_PASSWORD
          value: "changeme_admin123"
        volumeMounts:
apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-topic-init
  namespace: redpanda
  annotations:
    # Run after redpanda is ready
    argocd.argoproj.io/hook: PostSync
spec:
  template:
    spec:
      containers:
      - name: rpk-topic-create
        image: docker.redpanda.com/redpandadata/redpanda:v23.3.4
        command: ["/bin/bash", "-c"]
        args:
        - |
          echo "Waiting for Redpanda to be ready..."
          rpk cluster health --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          echo "Creating topics..."
          # E1.S2: audit.events.v1 (12 partitions, replication 3)
          rpk topic create audit.events.v1 -p 12 -r 3 --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          # E1.S2: audit.events.dlq (3 partitions, replication 3)
          rpk topic create audit.events.dlq -p 3 -r 3 --brokers redpanda-0.redpanda.redpanda.svc.cluster.local:9093 --tls-enabled --tls-truststore /etc/tls/certs/ca.crt --user admin --password $ADMIN_PASSWORD --sasl-mechanism SCRAM-SHA-256
          
          echo "Topics created successfully."
        env:
        - name: ADMIN_PASSWORD
          value: "changeme_admin123"
        volumeMounts:
        # Mount TLS certs from the secret generated by cert-manager for the cluster
        - name: tls-certs
          mountPath: /etc/tls/certs
          readOnly: true
      restartPolicy: OnFailure
      volumes:
      - name: tls-certs
        secret:
          secretName: redpanda-default-cert
