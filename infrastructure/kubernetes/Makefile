# Turia Trails - Infrastructure Makefile

# Variables
CLUSTER_NAME := turia-local
KUBECONFIG := $(HOME)/.kube/config

# Tools versions
CERT_MANAGER_VERSION := v1.13.3

.PHONY: all setup clean deploy verify

all: setup deploy verify

# 1. Provision Cluster & Dependencies
setup:
	@echo "ğŸš€ Provisioning Kind cluster..."
	kind create cluster --name $(CLUSTER_NAME) --config kind-cluster.yaml || true
	
	@echo "ğŸ“¦ Installing Cert-Manager (Helm)..."
	helm repo add jetstack https://charts.jetstack.io
	helm repo update
	helm upgrade --install cert-manager jetstack/cert-manager \
		--namespace cert-manager \
		--create-namespace \
		--version $(CERT_MANAGER_VERSION) \
		--set installCRDs=true \
		--wait

# 2. Deploy Infrastructure Manifests
deploy:
	@echo "ğŸ—ï¸ Applying Kubernetes Manifests (Kustomize)..."
	kubectl apply -k .

# 3. Verify Installation
verify:
	@echo "ğŸ” Verifying Workloads..."
	kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=90s
	kubectl rollout status deployment/metrics-server -n kube-system --timeout=90s
	@echo "âœ… Infrastructure Ready!"

# Clean everything
clean:
	@echo "ğŸ§¹ Cleaning up..."
	kind delete cluster --name $(CLUSTER_NAME)
